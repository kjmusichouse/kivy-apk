name: Build APK with Buildozer
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo apt-get clean
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip unzip openjdk-11-jdk python3-pip build-essential libncurses6 libncurses-dev
        pip install --user buildozer==1.5.0 cython==0.29.36 kivy==2.3.0 pyjnius
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '9477386'  # Version 9.0, compatible with Java 11
        accept-android-sdk-licenses: true
        log-accepted-android-sdk-licenses: true
        packages: 'platform-tools build-tools;33.0.2 platforms;android-33 ndk;25.2.9519653'
    - name: Set Android SDK environment variables
      run: |
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/9.0/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
    - name: Clear Buildozer cache
      run: |
        rm -rf ~/.buildozer .buildozer
    - name: Update buildozer.spec
      run: |
        # Remove any existing android.sdk_path entries to avoid duplicates
        sed -i '/android.sdk_path/d' buildozer.spec
        # Add correct android.sdk_path
        echo "android.sdk_path = /usr/local/lib/android/sdk" >> buildozer.spec
        # Update other settings, ensuring no duplicates
        sed -i '/android.ndk_path/d' buildozer.spec
        echo "android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653" >> buildozer.spec
        sed -i '/android.api/d' buildozer.spec
        echo "android.api = 33" >> buildozer.spec
        sed -i '/android.ndk/d' buildozer.spec
        echo "android.ndk = 25.2.9519653" >> buildozer.spec
        sed -i '/requirements/d' buildozer.spec
        echo "requirements = python3,kivy==2.3.0,pyjnius" >> buildozer.spec
        sed -i '/android.accept_sdk_license/d' buildozer.spec
        echo "android.accept_sdk_license = True" >> buildozer.spec
    - name: Build APK with Buildozer
      run: |
        buildozer -v android debug
    - name: Debug SDK and Java
      if: failure()
      run: |
        java -version
        echo $ANDROID_HOME
        ls -la $ANDROID_HOME/cmdline-tools
        $ANDROID_HOME/cmdline-tools/9.0/bin/sdkmanager --version
        cat buildozer.spec
