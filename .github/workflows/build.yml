- name: 📦 Install Android SDK & NDK
  run: |
    set -e

    SDK_DIR=$HOME/android-sdk
    CMD_TOOLS_ZIP=commandlinetools-linux-9477386_latest.zip
    CMD_TOOLS_URL=https://dl.google.com/android/repository/$CMD_TOOLS_ZIP

    echo "📦 Downloading Android command-line tools..."
    mkdir -p $SDK_DIR/cmdline-tools
    cd $SDK_DIR/cmdline-tools
    wget -q $CMD_TOOLS_URL

    echo "📂 Unzipping command-line tools..."
    unzip -q $CMD_TOOLS_ZIP
    rm $CMD_TOOLS_ZIP

    # Debug: List contents after unzip
    echo "📁 Contents of $SDK_DIR/cmdline-tools after unzip:"
    ls -la $SDK_DIR/cmdline-tools

    # Normalize folder structure
    if [ -d "cmdline-tools" ]; then
      echo "📁 Fixing nested folder structure..."
      mv cmdline-tools cmdline-tools-temp
      mkdir cmdline-tools
      mv cmdline-tools-temp/* cmdline-tools/
      rmdir cmdline-tools-temp
    else
      echo "📁 No nested cmdline-tools folder found, assuming flat structure."
      mkdir -p cmdline-tools
      mv * cmdline-tools/ 2>/dev/null || true
    fi

    # Debug: List final directory structure
    echo "📁 Final contents of $SDK_DIR/cmdline-tools:"
    ls -la $SDK_DIR/cmdline-tools
    echo "📁 Contents of $SDK_DIR/cmdline-tools/cmdline-tools:"
    ls -la $SDK_DIR/cmdline-tools/cmdline-tools || echo "❌ Directory not found"

    # Ensure bin directory exists
    if [ ! -d "$SDK_DIR/cmdline-tools/cmdline-tools/bin" ]; then
      echo "❌ Bin directory not found at $SDK_DIR/cmdline-tools/cmdline-tools/bin"
      exit 1
    fi

    # Set env vars
    echo "ANDROID_HOME=$SDK_DIR" >> $GITHUB_ENV
    echo "ANDROID_SDK_ROOT=$SDK_DIR" >> $GITHUB_ENV
    echo "$SDK_DIR/cmdline-tools/cmdline-tools/bin" >> $GITHUB_PATH
    echo "$SDK_DIR/platform-tools" >> $GITHUB_PATH

    # Temporary export for current shell
    export PATH="$SDK_DIR/cmdline-tools/cmdline-tools/bin:$SDK_DIR/platform-tools:$PATH"

    echo "🧪 Checking sdkmanager..."
    echo "PATH = $PATH"
    ls -la $SDK_DIR/cmdline-tools/cmdline-tools/bin/

    # Verify sdkmanager
    if ! command -v sdkmanager; then
      echo "❌ sdkmanager not found in PATH."
      exit 1
    fi

    sdkmanager --version || { echo "❌ sdkmanager failed to run."; exit 1; }

    echo "✅ sdkmanager is installed and working."
